# Mitaba&#x301;

Проект использует [Docker](https://www.docker.com/what-docker), в частности утилиту [Docker Compose](https://docs.docker.com/compose/) в качестве платформы разработки и деплоя, поэтому все операции разворачивания и администрирования будут проходить через него. Данный ридми поможет преодолеть нубическость в нём.

Установите Docker и убедитесь в успехе через `$ docker -v` и `$ docker-compose -v`.


## Docker для самых маленьких

Поднять докер `$ docker-compose up`. Первый раз, после сборки, может слететь с ошибкой "не найдена база", но это вранье, она просто "не успела кончить". Нужно остановить `Ctrl+C` а потом ещё раз поднять докер `$ docker-compose up`.


### Первоначальная настройка базы данных

Для этого зайти через `$ docker exec -it mimimigit_web_1 bash` внутрь работающего контейнера (где его имя `mimimigit_web_1` может отличаться, надо проверить выполнив `$ docker container ls` и найдя имя с суффиксом `_web_` в списке активных контейнеров).

Сделать миграции свежего Django с помощью `$ python manage.py migrate`. Затем создать суперюзера через `$ python manage.py createsuperuser` с логином и паролем. Всё, теперь с ними можно заходить в админку по адресу `/admin`.

**Данные базы хранятся в отдельном volume `db_data` (см. docker-compose.yml)!**

Поэтому не нужно будет делать повторные миграции при пересборке докер-образа.

**Код проекта маунтится прямо с диска хост-машины, но это его тоже нужно будет перенести в `volumes` и разобраться как деплоить раздельно а так же переносить данные с сервера на сервер.**

### Пересобрать докер-образ

При изменении зависимостей в `app/requirements.txt` нужно пересобирать образ через `docker-compose up --build` (автоматически докер 'поднимется' после завершения сборки)

### Очистка экосистемы докера

При работе с докером он зажирает место очень быстро, поэтому нужно периодически чистить лишнее, см. хелп докера. Но будь осторожен **не похерь volume базы данных!**

Периодически делай дамп базы изнутри контейнера `make dumpdata` (см. `/app/makefile` для других команд)

## Настройки Django для разработки

Файл `settings.py` не хранится в репозитории, его нужно попросить у <antivitla@gmail.com> и положить в `app/mitaba/core/`. Без этого проект не запустится.

## Обновление сертификатов

```
ssh mitaba.ru
cd /projects/mitaba.ru
make down
sudo certbot renew
make up
exit
```
